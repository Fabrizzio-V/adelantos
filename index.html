<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Adelantos - Google Sheets</title>
</head>
<body>
    <!-- Aquí va tu contenido HTML, formularios, tablas, etc. -->

    <script>
    // Variables globales de ejemplo
    let WEB_APP_URL = localStorage.getItem('webAppUrl') || '';
    let advances = [];
    let currentUser = localStorage.getItem('currentUser') || '';

    // Guardar en Google Sheets
    async function saveToSheets(action, data) {
        if (!WEB_APP_URL) return false;
        updateSyncStatus('syncing', 'Guardando...');
        try {
            const response = await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action, ...data })
            });
            // Leer la respuesta si es posible
            let result = { status: 'success' };
            if (response.ok) {
                try {
                    result = await response.json();
                } catch (e) {
                    // Si no es JSON, mantener success
                }
            }
            updateSyncStatus('success', 'Guardado');
            setTimeout(() => updateSyncStatus('', '✓ En línea'), 2000);
            localStorage.setItem('advances_backup', JSON.stringify(advances));
            if (action === 'create') {
                return { status: 'success', id: Date.now() };
            }
            return result;
        } catch (error) {
            console.error('Error:', error);
            updateSyncStatus('error', 'Error al guardar - Modo offline');
            localStorage.setItem('advances_backup', JSON.stringify(advances));
            if (action === 'create') {
                return { status: 'success', id: Date.now() };
            }
            return { status: 'error' };
        }
    }

    // Función para actualizar el estado de sincronización (puedes personalizarla)
    function updateSyncStatus(status, text) {
        // Aquí puedes actualizar el DOM para mostrar el estado de sincronización
        console.log(`[SyncStatus] ${status}: ${text}`);
    }

    // Función para mostrar notificaciones (puedes personalizarla)
    function showNotification(message) {
        alert(message); // O usa tu propio sistema de notificaciones
    }

    // Función para recargar datos (debes implementarla según tu lógica)
    async function loadData() {
        // Aquí va tu lógica para recargar los datos desde Google Sheets
        console.log('Recargando datos...');
    }

    // Función deleteAdvance CORREGIDA Y MEJORADA
    async function deleteAdvance(id) {
        if (!confirm('¿Está seguro de eliminar este adelanto?')) return;
        updateSyncStatus('syncing', 'Eliminando...');
        try {
            const result = await saveToSheets('delete', {
                id: String(id).trim(),
                deletedBy: currentUser
            });
            if (result && result.status === 'success') {
                await loadData();
                showNotification('Adelanto eliminado');
            } else {
                showNotification('No se pudo eliminar el adelanto. Intente de nuevo.');
            }
        } catch (error) {
            showNotification('Error al eliminar. Revise la conexión.');
            console.error(error);
        }
    }
    </script>
</body>
</html>
